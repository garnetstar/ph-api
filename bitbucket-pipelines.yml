image: garnetstar/pg-api-build:php7.2

definitions:
  caches:
    vendor: src/vendor

  steps:
    - step: &Test-step
        name: Run tests
        script:
          - ls -la
          -
pipelines:
  default:
    - step: *Test-step

  branches:
    master:
    - step: *Test-step
    - step:
        caches:
          - vendor
        name: Instal vendor dependencies
        script:
          - cd src
          - composer install
    - step:
        services:
            - docker
        caches:
          - vendor
        name: Build and push docker image
        script:
          - export IMAGE_NAME=garnetstar/pg-api:$BITBUCKET_COMMIT
          - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
          - docker build --no-cache -f ./Docker/deploy/Dockerfile -t $IMAGE_NAME .
          - docker images
          - docker push $IMAGE_NAME

